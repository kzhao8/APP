<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教会出勤记录</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36D399',
                        accent: '#FF9F43',
                        neutral: '#3D4451',
                        'base-100': '#FFFFFF',
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .animate-fade-in {
                animation: fadeIn 0.3s ease-in-out;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-gray-800 min-h-screen flex flex-col">
    <!-- 顶部导航栏 -->
    <header class="bg-primary text-white shadow-md">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <i class="fa fa-church text-2xl"></i>
                <h1 class="text-xl md:text-2xl font-bold">教会出勤记录</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button id="export-btn" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition-all duration-300 flex items-center">
                    <i class="fa fa-download mr-2"></i>
                    <span class="hidden sm:inline">导出数据</span>
                </button>
                <button id="settings-btn" class="bg-white/20 hover:bg-white/30 p-2 rounded-lg transition-all duration-300">
                    <i class="fa fa-cog"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="flex-grow container mx-auto px-4 py-6">
        <!-- 日期和视图选择 -->
        <div class="mb-6 bg-white rounded-xl shadow-sm p-4">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center space-x-2">
                    <button id="prev-date" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                        <i class="fa fa-chevron-left"></i>
                    </button>
                    <h2 id="current-date" class="text-lg font-semibold">2025年6月26日 周四</h2>
                    <button id="next-date" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                        <i class="fa fa-chevron-right"></i>
                    </button>
                    <button id="today-btn" class="ml-2 bg-primary/10 text-primary px-3 py-1 rounded-lg text-sm font-medium hover:bg-primary/20 transition-colors">
                        今天
                    </button>
                </div>
                
                <div class="flex items-center space-x-2">
                    <button id="friday-btn" class="px-4 py-2 rounded-lg bg-primary text-white font-medium">周五礼拜</button>
                    <button id="sunday-btn" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 font-medium transition-colors">周日礼拜</button>
                </div>
            </div>
        </div>

        <!-- 主要内容区域 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- 左侧：小组列表 -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-sm h-full flex flex-col">
                    <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                        <h3 class="font-semibold text-lg">小组列表</h3>
                        <button id="add-group-btn" class="bg-secondary text-white p-2 rounded-lg hover:bg-secondary/90 transition-colors">
                            <i class="fa fa-plus"></i>
                        </button>
                    </div>
                    <div id="groups-container" class="flex-grow overflow-y-auto scrollbar-hide p-4 space-y-3">
                        <!-- 小组项会动态添加到这里 -->
                    </div>
                </div>
            </div>

            <!-- 右侧：成员和出勤记录 -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl shadow-sm h-full flex flex-col">
                    <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                        <div>
                            <h3 id="current-group-name" class="font-semibold text-lg">未选择小组</h3>
                            <p id="current-group-count" class="text-sm text-gray-500">0 名成员</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="add-member-btn" class="bg-primary text-white px-3 py-1.5 rounded-lg text-sm font-medium hover:bg-primary/90 transition-colors flex items-center">
                                <i class="fa fa-user-plus mr-1"></i> 添加成员
                            </button>
                            <div class="relative">
                                <button id="attendance-filter" class="bg-gray-100 hover:bg-gray-200 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors flex items-center">
                                    <i class="fa fa-filter mr-1"></i> 筛选
                                    <i class="fa fa-chevron-down ml-1 text-xs"></i>
                                </button>
                                <div id="filter-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg z-10 py-2">
                                    <a href="#" class="block px-4 py-2 text-sm hover:bg-gray-100 filter-option" data-filter="all">全部成员</a>
                                    <a href="#" class="block px-4 py-2 text-sm hover:bg-gray-100 filter-option" data-filter="present">已出席</a>
                                    <a href="#" class="block px-4 py-2 text-sm hover:bg-gray-100 filter-option" data-filter="absent">未出席</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center space-x-2">
                                <span class="inline-block w-3 h-3 rounded-full bg-secondary"></span>
                                <span class="text-sm text-gray-600">出席</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="inline-block w-3 h-3 rounded-full bg-red-400"></span>
                                <span class="text-sm text-gray-600">缺席</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button id="mark-all-present" class="text-primary text-sm hover:underline">全部出席</button>
                                <span class="text-gray-300">|</span>
                                <button id="mark-all-absent" class="text-primary text-sm hover:underline">全部缺席</button>
                            </div>
                        </div>
                        
                        <div id="members-container" class="space-y-3">
                            <!-- 成员项会动态添加到这里 -->
                            <div class="text-center py-12 text-gray-400">
                                <i class="fa fa-users text-4xl mb-3"></i>
                                <p>请从左侧选择一个小组</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-gray-800 text-white py-6">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <p class="text-sm">© 2025 教会出勤记录系统</p>
                </div>
                <div class="flex space-x-4">
                    <a href="#" class="text-gray-300 hover:text-white transition-colors">
                        <i class="fa fa-question-circle"></i> 帮助
                    </a>
                    <a href="#" class="text-gray-300 hover:text-white transition-colors">
                        <i class="fa fa-info-circle"></i> 关于
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <!-- 添加小组模态框 -->
    <div id="add-group-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-6 animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-semibold text-lg">添加新小组</h3>
                <button id="close-group-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <form id="add-group-form">
                <div class="mb-4">
                    <label for="group-name" class="block text-sm font-medium text-gray-700 mb-1">小组名称</label>
                    <input type="text" id="group-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all" placeholder="例如：青年团契" required>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-group-btn" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">取消</button>
                    <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">添加小组</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 添加成员模态框 -->
    <div id="add-member-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-6 animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-semibold text-lg">添加新成员</h3>
                <button id="close-member-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <form id="add-member-form">
                <div class="mb-4">
                    <label for="member-name" class="block text-sm font-medium text-gray-700 mb-1">姓名</label>
                    <input type="text" id="member-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all" placeholder="请输入姓名" required>
                </div>
                <div class="mb-4">
                    <label for="member-gender" class="block text-sm font-medium text-gray-700 mb-1">性别</label>
                    <div class="flex space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="gender" value="male" class="form-radio text-primary focus:ring-primary" checked>
                            <span class="ml-2">男</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="gender" value="female" class="form-radio text-primary focus:ring-primary">
                            <span class="ml-2">女</span>
                        </label>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="member-phone" class="block text-sm font-medium text-gray-700 mb-1">联系电话</label>
                    <input type="tel" id="member-phone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all" placeholder="请输入联系电话">
                </div>
                <div class="mb-4">
                    <label for="member-notes" class="block text-sm font-medium text-gray-700 mb-1">备注</label>
                    <textarea id="member-notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all" placeholder="添加备注信息（可选）"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-member-btn" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">取消</button>
                    <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">添加成员</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 设置模态框 -->
    <div id="settings-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-6 animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-semibold text-lg">系统设置</h3>
                <button id="close-settings-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <form id="settings-form">
                <div class="mb-4">
                    <label for="church-name" class="block text-sm font-medium text-gray-700 mb-1">教会名称</label>
                    <input type="text" id="church-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all" placeholder="请输入教会名称">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">礼拜时间设置</label>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <span class="w-20">周五礼拜</span>
                            <input type="time" id="friday-time" class="ml-2 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all">
                        </div>
                        <div class="flex items-center">
                            <span class="w-20">周日礼拜</span>
                            <input type="time" id="sunday-time" class="ml-2 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all">
                        </div>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">数据管理</label>
                    <div class="space-y-2">
                        <button type="button" id="backup-data-btn" class="w-full text-left px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors flex items-center">
                            <i class="fa fa-download mr-2 text-gray-500"></i> 备份数据
                        </button>
                        <button type="button" id="restore-data-btn" class="w-full text-left px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors flex items-center">
                            <i class="fa fa-upload mr-2 text-gray-500"></i> 恢复数据
                        </button>
                        <button type="button" id="clear-data-btn" class="w-full text-left px-3 py-2 border border-red-300 text-red-600 rounded-lg hover:bg-red-50 transition-colors flex items-center">
                            <i class="fa fa-trash mr-2"></i> 清空所有数据
                        </button>
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-settings-btn" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">取消</button>
                    <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">保存设置</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 初始化数据结构
        let churchData = {
            settings: {
                churchName: "基督教会",
                fridayTime: "19:00",
                sundayTime: "10:00"
            },
            groups: [],
            attendance: {
                // 示例格式: "2025-06-26-friday": { groupId: [ {memberId, present}, ... ] }
            }
        };

        // 当前选中的日期和礼拜类型
        let currentDate = new Date();
        let currentServiceType = 'friday';

        // DOM 加载完成后初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            // 从本地存储加载数据
            loadData();
            
            // 初始化日期显示
            updateDateDisplay();
            
            // 初始化事件监听器
            initEventListeners();
            
            // 渲染小组列表
            renderGroups();
        });

        // 从本地存储加载数据
        function loadData() {
            const savedData = localStorage.getItem('churchAttendanceData');
            if (savedData) {
                churchData = JSON.parse(savedData);
            }
        }

        // 保存数据到本地存储
        function saveData() {
            localStorage.setItem('churchAttendanceData', JSON.stringify(churchData));
        }

        // 更新日期显示
        function updateDateDisplay() {
            const weekdays = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth() + 1;
            const date = currentDate.getDate();
            const weekday = weekdays[currentDate.getDay()];
            
            document.getElementById('current-date').textContent = `${year}年${month}月${date}日 ${weekday}`;
        }

        // 初始化事件监听器
        function initEventListeners() {
            // 日期导航按钮
            document.getElementById('prev-date').addEventListener('click', () => {
                currentDate.setDate(currentDate.getDate() - 1);
                updateDateDisplay();
                renderMembers();
            });
            
            document.getElementById('next-date').addEventListener('click', () => {
                currentDate.setDate(currentDate.getDate() + 1);
                updateDateDisplay();
                renderMembers();
            });
            
            document.getElementById('today-btn').addEventListener('click', () => {
                currentDate = new Date();
                updateDateDisplay();
                renderMembers();
            });
            
            // 礼拜类型切换
            document.getElementById('friday-btn').addEventListener('click', () => {
                currentServiceType = 'friday';
                document.getElementById('friday-btn').classList.remove('bg-gray-200', 'hover:bg-gray-300');
                document.getElementById('friday-btn').classList.add('bg-primary', 'text-white');
                document.getElementById('sunday-btn').classList.remove('bg-primary', 'text-white');
                document.getElementById('sunday-btn').classList.add('bg-gray-200', 'hover:bg-gray-300');
                renderMembers();
            });
            
            document.getElementById('sunday-btn').addEventListener('click', () => {
                currentServiceType = 'sunday';
                document.getElementById('sunday-btn').classList.remove('bg-gray-200', 'hover:bg-gray-300');
                document.getElementById('sunday-btn').classList.add('bg-primary', 'text-white');
                document.getElementById('friday-btn').classList.remove('bg-primary', 'text-white');
                document.getElementById('friday-btn').classList.add('bg-gray-200', 'hover:bg-gray-300');
                renderMembers();
            });
            
            // 添加小组按钮
            document.getElementById('add-group-btn').addEventListener('click', () => {
                document.getElementById('add-group-modal').classList.remove('hidden');
                document.getElementById('group-name').focus();
            });
            
            // 关闭添加小组模态框
            document.getElementById('close-group-modal').addEventListener('click', () => {
                document.getElementById('add-group-modal').classList.add('hidden');
                document.getElementById('add-group-form').reset();
            });
            
            document.getElementById('cancel-group-btn').addEventListener('click', () => {
                document.getElementById('add-group-modal').classList.add('hidden');
                document.getElementById('add-group-form').reset();
            });
            
            // 添加小组表单提交
            document.getElementById('add-group-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const groupName = document.getElementById('group-name').value.trim();
                if (groupName) {
                    addGroup(groupName);
                    document.getElementById('add-group-modal').classList.add('hidden');
                    document.getElementById('add-group-form').reset();
                }
            });
            
            // 添加成员按钮
            document.getElementById('add-member-btn').addEventListener('click', () => {
                document.getElementById('add-member-modal').classList.remove('hidden');
                document.getElementById('member-name').focus();
            });
            
            // 关闭添加成员模态框
            document.getElementById('close-member-modal').addEventListener('click', () => {
                document.getElementById('add-member-modal').classList.add('hidden');
                document.getElementById('add-member-form').reset();
            });
            
            document.getElementById('cancel-member-btn').addEventListener('click', () => {
                document.getElementById('add-member-modal').classList.add('hidden');
                document.getElementById('add-member-form').reset();
            });
            
            // 添加成员表单提交
            document.getElementById('add-member-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const memberName = document.getElementById('member-name').value.trim();
                const memberGender = document.querySelector('input[name="gender"]:checked').value;
                const memberPhone = document.getElementById('member-phone').value.trim();
                const memberNotes = document.getElementById('member-notes').value.trim();
                
                if (memberName) {
                    const selectedGroupId = getSelectedGroupId();
                    if (selectedGroupId) {
                        addMember(selectedGroupId, memberName, memberGender, memberPhone, memberNotes);
                        document.getElementById('add-member-modal').classList.add('hidden');
                        document.getElementById('add-member-form').reset();
                    } else {
                        alert('请先选择一个小组');
                    }
                }
            });
            
            // 设置按钮
            document.getElementById('settings-btn').addEventListener('click', () => {
                document.getElementById('settings-modal').classList.remove('hidden');
                // 填充设置表单
                document.getElementById('church-name').value = churchData.settings.churchName;
                document.getElementById('friday-time').value = churchData.settings.fridayTime;
                document.getElementById('sunday-time').value = churchData.settings.sundayTime;
            });
            
            // 关闭设置模态框
            document.getElementById('close-settings-modal').addEventListener('click', () => {
                document.getElementById('settings-modal').classList.add('hidden');
            });
            
            document.getElementById('cancel-settings-btn').addEventListener('click', () => {
                document.getElementById('settings-modal').classList.add('hidden');
            });
            
            // 设置表单提交
            document.getElementById('settings-form').addEventListener('submit', (e) => {
                e.preventDefault();
                churchData.settings.churchName = document.getElementById('church-name').value.trim();
                churchData.settings.fridayTime = document.getElementById('friday-time').value;
                churchData.settings.sundayTime = document.getElementById('sunday-time').value;
                saveData();
                document.getElementById('settings-modal').classList.add('hidden');
                alert('设置已保存');
            });
            
            // 数据管理按钮
            document.getElementById('backup-data-btn').addEventListener('click', backupData);
            document.getElementById('restore-data-btn').addEventListener('click', restoreData);
            document.getElementById('clear-data-btn').addEventListener('click', clearData);
            
            // 导出数据按钮
            document.getElementById('export-btn').addEventListener('click', exportAttendanceData);
            
            // 筛选下拉菜单
            document.getElementById('attendance-filter').addEventListener('click', () => {
                document.getElementById('filter-dropdown').classList.toggle('hidden');
            });
            
            // 点击其他区域关闭下拉菜单
            document.addEventListener('click', (e) => {
                if (!document.getElementById('attendance-filter').contains(e.target) && 
                    !document.getElementById('filter-dropdown').contains(e.target)) {
                    document.getElementById('filter-dropdown').classList.add('hidden');
                }
            });
            
            // 筛选选项
            document.querySelectorAll('.filter-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    e.preventDefault();
                    const filter = e.target.dataset.filter;
                    document.querySelectorAll('.filter-option').forEach(opt => {
                        opt.classList.remove('bg-gray-100');
                    });
                    e.target.classList.add('bg-gray-100');
                    filterMembers(filter);
                    document.getElementById('filter-dropdown').classList.add('hidden');
                });
            });
            
            // 全选/全不选按钮
            document.getElementById('mark-all-present').addEventListener('click', () => {
                const selectedGroupId = getSelectedGroupId();
                if (selectedGroupId) {
                    markAllMembers(selectedGroupId, true);
                }
            });
            
            document.getElementById('mark-all-absent').addEventListener('click', () => {
                const selectedGroupId = getSelectedGroupId();
                if (selectedGroupId) {
                    markAllMembers(selectedGroupId, false);
                }
            });
        }

        // 添加新小组
        function addGroup(name) {
            const newGroup = {
                id: Date.now().toString(),
                name,
                members: []
            };
            
            churchData.groups.push(newGroup);
            saveData();
            renderGroups();
        }

        // 添加新成员
        function addMember(groupId, name, gender, phone, notes) {
            const group = churchData.groups.find(g => g.id === groupId);
            if (group) {
                const newMember = {
                    id: Date.now().toString(),
                    name,
                    gender,
                    phone,
                    notes
                };
                
                group.members.push(newMember);
                saveData();
                renderMembers();
            }
        }

        // 渲染小组列表
        function renderGroups() {
            const groupsContainer = document.getElementById('groups-container');
            groupsContainer.innerHTML = '';
            
            if (churchData.groups.length === 0) {
                groupsContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <i class="fa fa-folder-open-o text-3xl mb-2"></i>
                        <p>还没有小组，请添加新小组</p>
                    </div>
                `;
                return;
            }
            
            churchData.groups.forEach(group => {
                const groupElement = document.createElement('div');
                groupElement.className = 'bg-gray-50 rounded-lg p-3 flex justify-between items-center hover:bg-gray-100 transition-colors cursor-pointer group-item';
                groupElement.dataset.groupId = group.id;
                
                groupElement.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-primary mr-3">
                            <i class="fa fa-users"></i>
                        </div>
                        <div>
                            <h4 class="font-medium">${group.name}</h4>
                            <p class="text-xs text-gray-500">${group.members.length} 名成员</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button class="edit-group-btn p-1.5 rounded-full hover:bg-gray-200 text-gray-600" title="编辑">
                            <i class="fa fa-pencil"></i>
                        </button>
                        <button class="delete-group-btn p-1.5 rounded-full hover:bg-red-100 text-red-500" title="删除">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                `;
                
                groupsContainer.appendChild(groupElement);
                
                // 添加小组点击事件
                groupElement.addEventListener('click', () => {
                    document.querySelectorAll('.group-item').forEach(item => {
                        item.classList.remove('bg-primary/10', 'border-l-4', 'border-primary');
                    });
                    groupElement.classList.add('bg-primary/10', 'border-l-4', 'border-primary');
                    renderMembers(group.id);
                });
                
                // 添加编辑小组事件
                groupElement.querySelector('.edit-group-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const groupName = prompt('请输入新的小组名称', group.name);
                    if (groupName && groupName.trim() !== '') {
                        group.name = groupName.trim();
                        saveData();
                        renderGroups();
                        // 如果当前正在查看这个小组，更新标题
                        const selectedGroupId = getSelectedGroupId();
                        if (selectedGroupId === group.id) {
                            document.getElementById('current-group-name').textContent = group.name;
                        }
                    }
                });
                
                // 添加删除小组事件
                groupElement.querySelector('.delete-group-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm(`确定要删除小组"${group.name}"吗？这将删除该小组及其所有成员。`)) {
                        const index = churchData.groups.findIndex(g => g.id === group.id);
                        if (index !== -1) {
                            churchData.groups.splice(index, 1);
                            saveData();
                            renderGroups();
                            
                            // 如果删除的是当前选中的小组，重置成员列表
                            const selectedGroupId = getSelectedGroupId();
                            if (selectedGroupId === group.id) {
                                document.getElementById('current-group-name').textContent = '未选择小组';
                                document.getElementById('current-group-count').textContent = '0 名成员';
                                renderMembers();
                            }
                        }
                    }
                });
            });
            
            // 如果有小组，默认选中第一个
            if (churchData.groups.length > 0 && !getSelectedGroupId()) {
                groupsContainer.querySelector('.group-item').click();
            }
        }

        // 渲染成员列表
        function renderMembers(groupId = null) {
            const membersContainer = document.getElementById('members-container');
            const currentDateStr = formatDate(currentDate);
            const attendanceKey = `${currentDateStr}-${currentServiceType}`;
            
            // 如果没有提供groupId，获取当前选中的小组ID
            if (!groupId) {
                groupId = getSelectedGroupId();
            }
            
            // 如果没有选中的小组，显示提示信息
            if (!groupId) {
                membersContainer.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <i class="fa fa-users text-4xl mb-3"></i>
                        <p>请从左侧选择一个小组</p>
                    </div>
                `;
                return;
            }
            
            const group = churchData.groups.find(g => g.id === groupId);
            if (!group) return;
            
            // 更新当前小组名称和成员数量
            document.getElementById('current-group-name').textContent = group.name;
            document.getElementById('current-group-count').textContent = `${group.members.length} 名成员`;
            
            // 如果没有成员，显示提示信息
            if (group.members.length === 0) {
                membersContainer.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <i class="fa fa-user-plus text-4xl mb-3"></i>
                        <p>该小组还没有成员，请添加新成员</p>
                    </div>
                `;
                return;
            }
            
            // 确保考勤数据结构存在
            if (!churchData.attendance[attendanceKey]) {
                churchData.attendance[attendanceKey] = {};
            }
            
            if (!churchData.attendance[attendanceKey][groupId]) {
                // 初始化该小组的考勤数据
                churchData.attendance[attendanceKey][groupId] = group.members.map(member => ({
                    memberId: member.id,
                    present: false
                }));
                saveData();
            }
            
            // 获取当前小组的考勤数据
            const groupAttendance = churchData.attendance[attendanceKey][groupId];
            
            // 清空容器
            membersContainer.innerHTML = '';
            
            // 渲染每个成员
            group.members.forEach(member => {
                // 查找成员的考勤状态
                const attendanceRecord = groupAttendance.find(record => record.memberId === member.id);
                const isPresent = attendanceRecord ? attendanceRecord.present : false;
                
                const memberElement = document.createElement('div');
                memberElement.className = `bg-gray-50 rounded-lg p-3 flex justify-between items-center hover:bg-gray-100 transition-colors cursor-pointer ${isPresent ? 'border-l-4 border-secondary' : ''}`;
                memberElement.dataset.memberId = member.id;
                
                memberElement.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-primary mr-3">
                            <i class="fa fa-user"></i>
                        </div>
                        <div>
                            <h4 class="font-medium">${member.name}</h4>
                            <p class="text-xs text-gray-500">
                                ${member.gender === 'male' ? '男' : '女'}
                                ${member.phone ? ' | ' + member.phone : ''}
                            </p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer" ${isPresent ? 'checked' : ''}>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary/50 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-secondary"></div>
                        </label>
                        <div class="flex items-center space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button class="edit-member-btn p-1.5 rounded-full hover:bg-gray-200 text-gray-600" title="编辑">
                                <i class="fa fa-pencil"></i>
                            </button>
                            <button class="delete-member-btn p-1.5 rounded-full hover:bg-red-100 text-red-500" title="删除">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                membersContainer.appendChild(memberElement);
                
                // 添加考勤状态切换事件
                const checkbox = memberElement.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('change', () => {
                    toggleAttendance(groupId, member.id, checkbox.checked);
                });
                
                // 添加编辑成员事件
                memberElement.querySelector('.edit-member-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    editMember(groupId, member.id);
                });
                
                // 添加删除成员事件
                memberElement.querySelector('.delete-member-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm(`确定要删除成员"${member.name}"吗？`)) {
                        deleteMember(groupId, member.id);
                    }
                });
            });
        }

        // 获取当前选中的小组ID
        function getSelectedGroupId() {
            const selectedGroup = document.querySelector('.group-item.bg-primary/10');
            return selectedGroup ? selectedGroup.dataset.groupId : null;
        }

        // 切换成员考勤状态
        function toggleAttendance(groupId, memberId, isPresent) {
            const currentDateStr = formatDate(currentDate);
            const attendanceKey = `${currentDateStr}-${currentServiceType}`;
            
            // 确保考勤数据结构存在
            if (!churchData.attendance[attendanceKey]) {
                churchData.attendance[attendanceKey] = {};
            }
            
            if (!churchData.attendance[attendanceKey][groupId]) {
                // 获取小组所有成员
                const group = churchData.groups.find(g => g.id === groupId);
                if (group) {
                    // 初始化该小组的考勤数据
                    churchData.attendance[attendanceKey][groupId] = group.members.map(member => ({
                        memberId: member.id,
                        present: member.id === memberId ? isPresent : false
                    }));
                }
            } else {
                // 更新考勤状态
                const attendanceRecord = churchData.attendance[attendanceKey][groupId]
                    .find(record => record.memberId === memberId);
                
                if (attendanceRecord) {
                    attendanceRecord.present = isPresent;
                } else {
                    // 如果记录不存在，添加新记录
                    churchData.attendance[attendanceKey][groupId].push({
                        memberId,
                        present: isPresent
                    });
                }
            }
            
            saveData();
            renderMembers(groupId);
        }

        // 标记所有成员的考勤状态
        function markAllMembers(groupId, isPresent) {
            const currentDateStr = formatDate(currentDate);
            const attendanceKey = `${currentDateStr}-${currentServiceType}`;
            
            // 确保考勤数据结构存在
            if (!churchData.attendance[attendanceKey]) {
                churchData.attendance[attendanceKey] = {};
            }
            
            const group = churchData.groups.find(g => g.id === groupId);
            if (!group) return;
            
            // 初始化或更新该小组的考勤数据
            churchData.attendance[attendanceKey][groupId] = group.members.map(member => ({
                memberId: member.id,
                present: isPresent
            }));
            
            saveData();
            renderMembers(groupId);
        }

        // 编辑成员信息
        function editMember(groupId, memberId) {
            const group = churchData.groups.find(g => g.id === groupId);
            if (!group) return;
            
            const member = group.members.find(m => m.id === memberId);
            if (!member) return;
            
            // 填充编辑表单
            document.getElementById('member-name').value = member.name;
            document.querySelector(`input[name="gender"][value="${member.gender}"]`).checked = true;
            document.getElementById('member-phone').value = member.phone || '';
            document.getElementById('member-notes').value = member.notes || '';
            
            // 打开编辑模态框
            document.getElementById('add-member-modal').classList.remove('hidden');
            
            // 修改提交按钮文本
            const submitButton = document.querySelector('#add-member-form button[type="submit"]');
            submitButton.textContent = '保存修改';
            
            // 临时保存成员ID，用于提交表单时更新正确的成员
            submitButton.dataset.editMemberId = memberId;
            
            // 重写表单提交事件
            const form = document.getElementById('add-member-form');
            const originalSubmitHandler = form.onsubmit;
            
            form.onsubmit = function(e) {
                e.preventDefault();
                
                const newName = document.getElementById('member-name').value.trim();
                const newGender = document.querySelector('input[name="gender"]:checked').value;
                const newPhone = document.getElementById('member-phone').value.trim();
                const newNotes = document.getElementById('member-notes').value.trim();
                
                if (newName) {
                    // 更新成员信息
                    const memberIndex = group.members.findIndex(m => m.id === memberId);
                    if (memberIndex !== -1) {
                        group.members[memberIndex] = {
                            ...group.members[memberIndex],
                            name: newName,
                            gender: newGender,
                            phone: newPhone,
                            notes: newNotes
                        };
                        
                        saveData();
                        renderMembers(groupId);
                        
                        // 关闭模态框
                        document.getElementById('add-member-modal').classList.add('hidden');
                        form.reset();
                        
                        // 恢复原始提交事件
                        form.onsubmit = originalSubmitHandler;
                        submitButton.textContent = '添加成员';
                        delete submitButton.dataset.editMemberId;
                    }
                }
            };
        }

        // 删除成员
        function deleteMember(groupId, memberId) {
            const group = churchData.groups.find(g => g.id === groupId);
            if (!group) return;
            
            const memberIndex = group.members.findIndex(m => m.id === memberId);
            if (memberIndex !== -1) {
                group.members.splice(memberIndex, 1);
                saveData();
                renderMembers(groupId);
                
                // 清除考勤记录中该成员的数据
                Object.values(churchData.attendance).forEach(dateData => {
                    if (dateData[groupId]) {
                        dateData[groupId] = dateData[groupId].filter(record => record.memberId !== memberId);
                    }
                });
                
                saveData();
            }
        }

        // 筛选成员
        function filterMembers(filter) {
            const groupId = getSelectedGroupId();
            if (!groupId) return;
            
            const group = churchData.groups.find(g => g.id === groupId);
            if (!group) return;
            
            const currentDateStr = formatDate(currentDate);
            const attendanceKey = `${currentDateStr}-${currentServiceType}`;
            const groupAttendance = churchData.attendance[attendanceKey]?.[groupId] || [];
            
            const membersContainer = document.getElementById('members-container');
            membersContainer.innerHTML = '';
            
            // 过滤成员
            const filteredMembers = group.members.filter(member => {
                if (filter === 'all') return true;
                
                const attendanceRecord = groupAttendance.find(record => record.memberId === member.id);
                const isPresent = attendanceRecord ? attendanceRecord.present : false;
                
                return filter === 'present' ? isPresent : !isPresent;
            });
            
            // 如果没有匹配的成员，显示提示信息
            if (filteredMembers.length === 0) {
                membersContainer.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <i class="fa fa-search text-4xl mb-3"></i>
                        <p>没有找到匹配的成员</p>
                    </div>
                `;
                return;
            }
            
            // 渲染过滤后的成员
            filteredMembers.forEach(member => {
                // 查找成员的考勤状态
                const attendanceRecord = groupAttendance.find(record => record.memberId === member.id);
                const isPresent = attendanceRecord ? attendanceRecord.present : false;
                
                const memberElement = document.createElement('div');
                memberElement.className = `bg-gray-50 rounded-lg p-3 flex justify-between items-center hover:bg-gray-100 transition-colors cursor-pointer ${isPresent ? 'border-l-4 border-secondary' : ''}`;
                memberElement.dataset.memberId = member.id;
                
                memberElement.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-primary mr-3">
                            <i class="fa fa-user"></i>
                        </div>
                        <div>
                            <h4 class="font-medium">${member.name}</h4>
                            <p class="text-xs text-gray-500">
                                ${member.gender === 'male' ? '男' : '女'}
                                ${member.phone ? ' | ' + member.phone : ''}
                            </p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer" ${isPresent ? 'checked' : ''}>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary/50 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-secondary"></div>
                        </label>
                        <div class="flex items-center space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button class="edit-member-btn p-1.5 rounded-full hover:bg-gray-200 text-gray-600" title="编辑">
                                <i class="fa fa-pencil"></i>
                            </button>
                            <button class="delete-member-btn p-1.5 rounded-full hover:bg-red-100 text-red-500" title="删除">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                membersContainer.appendChild(memberElement);
                
                // 添加考勤状态切换事件
                const checkbox = memberElement.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('change', () => {
                    toggleAttendance(groupId, member.id, checkbox.checked);
                });
                
                // 添加编辑成员事件
                memberElement.querySelector('.edit-member-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    editMember(groupId, member.id);
                });
                
                // 添加删除成员事件
                memberElement.querySelector('.delete-member-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm(`确定要删除成员"${member.name}"吗？`)) {
                        deleteMember(groupId, member.id);
                    }
                });
            });
        }

        // 格式化日期为 YYYY-MM-DD
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // 备份数据
        function backupData() {
            const dataStr = JSON.stringify(churchData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `教会出勤记录备份_${formatDate(new Date())}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 恢复数据
        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const restoredData = JSON.parse(event.target.result);
                        
                        if (confirm('确定要恢复此数据吗？当前数据将被覆盖。')) {
                            churchData = restoredData;
                            saveData();
                            renderGroups();
                            renderMembers();
                            alert('数据已成功恢复');
                        }
                    } catch (error) {
                        alert('恢复数据失败: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // 清空所有数据
        function clearData() {
            if (confirm('确定要清空所有数据吗？此操作不可恢复。')) {
                churchData = {
                    settings: {
                        churchName: "基督教会",
                        fridayTime: "19:00",
                        sundayTime: "10:00"
                    },
                    groups: [],
                    attendance: {}
                };
                
                saveData();
                renderGroups();
                renderMembers();
                alert('所有数据已清空');
            }
        }

        // 导出当前考勤数据
        function exportAttendanceData() {
            const currentDateStr = formatDate(currentDate);
            const serviceTypeText = currentServiceType === 'friday' ? '周五礼拜' : '周日礼拜';
            
            // 准备导出的数据
            const exportData = [];
            
            churchData.groups.forEach(group => {
                const groupAttendance = churchData.attendance[`${currentDateStr}-${currentServiceType}`]?.[group.id] || [];
                
                group.members.forEach(member => {
                    const attendanceRecord = groupAttendance.find(record => record.memberId === member.id);
                    const isPresent = attendanceRecord ? attendanceRecord.present : false;
                    
                    exportData.push({
                        小组: group.name,
                        姓名: member.name,
                        性别: member.gender === 'male' ? '男' : '女',
                        联系电话: member.phone || '',
                        出席状态: isPresent ? '出席' : '缺席',
                        备注: member.notes || ''
                    });
                });
            });
            
            // 将数据转换为 CSV 格式
            const headers = Object.keys(exportData[0] || {}).join(',');
            const rows = exportData.map(row => Object.values(row).map(value => {
                // 处理包含逗号或引号的值
                if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                    return `"${value.replace(/"/g, '""')}"`;
                }
                return value;
            }).join(','));
            
            const csvContent = [headers, ...rows].join('\n');
            
            // 创建并下载 CSV 文件
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentDateStr}_${serviceTypeText}_出勤记录.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
    
